#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
labnote

Keith Hughitt <khughitt@umd.edu>
"""
import labnote

def main():
    """Generate HTML lab notebook"""
    import os
    import sys
    import shutil
    import time
    from collections import OrderedDict
    from jinja2 import Environment, PackageLoader
    from operator import itemgetter
    from pkg_resources import resource_filename, Requirement

    print("- Starting Labnote")

    # Load configuration
    parser = labnote.config.get_args()

    # Convert input arguments to a python dict
    args = parser.parse_args()
    args = dict((k, v) for k, v in list(vars(args).items()) if v is not None)

    # Get default args
    conf = labnote.config.load_config(args)
    
    # Update default arguments with user-specified settings
    conf.update(args)

    # Check for required parameters
    if 'input_dirs' not in conf:
        parser.print_help()
        print("Error: missing input directory(s).")
        sys.exit()
    elif 'output_dir' not in conf:
        parser.print_help()
        print("Error: missing output directory.")
        sys.exit()

    # Find matching lab notebook entries
    categories = {}

    # Find valid notebook entry directories
    filepaths = labnote.notebook.find_valid_files(conf['input_dirs'], 
                                                  conf['include_files'])

    # Iterate over matches files and create notebook entries
    for filepath in filepaths:
        # Entry directory and filename
        filename = os.path.basename(filepath)
        sub_dir = os.path.basename(os.path.dirname(filepath))

        entry = labnote.notebook.create_entry(filepath, conf['output_dir'],
                                                conf['url_prefix'])

        # determine category to use
        category = labnote.notebook.get_category(sub_dir, conf['categories'])
        
        # add entry to master dictionary
        if category not in categories:
            categories[category] = []
        categories[category].append(entry)

    # Show most recently modified entries first
    for category in categories:
        categories[category] = sorted(categories[category],
                                      key=itemgetter('date'), reverse=True)    

    # Sort categories by order of date last modified
    if conf['sort_categories_by_date']:
        categories = OrderedDict(sorted(categories.items(), 
                                        key=lambda x: x[1][0]['date'], 
                                        reverse=True))

    # Load Jinja2 template
    env = Environment(loader=PackageLoader('labnote', 'templates'))

    # Get current date string
    date = time.strftime('%Y/%m/%d')

    # Render template
    template = env.get_template('index.html')
    html = template.render(author=conf['author'], title=conf['title'],
                           email=conf['email'], date=date,
                           categories=categories)

    print("- Generating notebook HTML")

    # Output notebook
    outfile = os.path.join(conf['output_dir'], 'index.html')
    with open(outfile, 'w') as fp:
        fp.write(html)

    print("- Saving notebook to %s" % conf['output_dir'])

    # Path to resources/ directory
    resources = resource_filename(Requirement.parse('labnote'),
                                  os.path.join('labnote', 'resources'))

    # Copy CSS and image resources to output directory if it does not already
    # exist.
    resource_dir = os.path.join(conf['output_dir'], 'resources')

    if not os.path.isdir(resource_dir):
        shutil.copytree(resources, resource_dir,
                        ignore=shutil.ignore_patterns("__init__.py", "__pycache__"))

    print("- Finished")

if __name__ == '__main__':
    main()
